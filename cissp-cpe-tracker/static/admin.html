<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ISC² CPE Tracker — Storage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
</head>
<body>

<header>
  <div class="header-brand">
    <svg class="header-seal" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <polygon points="10,2 22,2 30,10 30,22 22,30 10,30 2,22 2,10"
        stroke-width="1.2" style="fill:var(--accent-dim);stroke:var(--accent)"/>
      <polygon points="11.5,5.5 20.5,5.5 26.5,11.5 26.5,20.5 20.5,26.5 11.5,26.5 5.5,20.5 5.5,11.5"
        fill="none" stroke-width="0.6" style="stroke:var(--accent-line)"/>
      <text x="16" y="15.5" text-anchor="middle"
        font-family="DM Sans, system-ui, sans-serif" font-size="5.5" font-weight="700" letter-spacing="0.12em"
        style="fill:var(--accent-bright)">ISC²</text>
      <text x="16" y="22.5" text-anchor="middle"
        font-family="DM Sans, system-ui, sans-serif" font-size="4.5" font-weight="600" letter-spacing="0.15em"
        style="fill:var(--accent)">CPE</text>
    </svg>
    <div class="header-title">
      <h1><span class="isc2-mark">ISC²</span> CPE Tracker
        <span style="color:var(--text-muted);font-weight:400;font-size:11px;letter-spacing:0.04em;text-transform:none">/ Storage</span>
      </h1>
      <span class="header-subtitle">Proof Screenshot Management</span>
    </div>
  </div>
  <div class="header-actions">
    <a href="/" class="btn-secondary">← Back</a>
  </div>
</header>

<main>

  <div style="margin-bottom:16px;display:flex;gap:16px;align-items:center;flex-wrap:wrap">
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn-secondary btn-sm" onclick="backfillPresenters()" id="btn-backfill">Fix Presenter Names</button>
      <span style="font-size:11px;color:var(--text-muted)">Re-fetches RSS, updates presenter field</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn-secondary btn-sm" onclick="backfillSubtitles()" id="btn-backfill-subtitles">Fix Subtitles</button>
      <span style="font-size:11px;color:var(--text-muted)">Re-fetches RSS, populates subtitle field on existing entries</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn-secondary btn-sm" onclick="backfillTitles()" id="btn-backfill-titles">Fix Titles</button>
      <span style="font-size:11px;color:var(--text-muted)">Renames "SN NNN:" → "Security Now NNN:" on all existing entries</span>
    </div>
  </div>

  <div class="summary-grid" id="storage-cards">
    <div class="card">
      <div class="label">Total Storage</div>
      <div class="value" id="stat-total-mb">—</div>
      <div class="sub" id="stat-total-kb"></div>
    </div>
    <div class="card">
      <div class="label">Screenshots</div>
      <div class="value" id="stat-file-count">—</div>
      <div class="sub">proof files</div>
    </div>
    <div class="card">
      <div class="label">Avg Size</div>
      <div class="value" id="stat-avg-kb">—</div>
      <div class="sub">KB per file</div>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>CPE Title</th>
          <th>Filename</th>
          <th>Size</th>
          <th>Preview</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="storage-tbody">
        <tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-dim)">Loading…</td></tr>
      </tbody>
    </table>
  </div>

</main>

<div id="toast"></div>

<script>
function $(id) { return document.getElementById(id); }

function showToast(msg, type = "success") {
  const t = $("toast");
  t.textContent = msg;
  t.className = `show ${type}`;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.className = ""; }, 3000);
}

function escHtml(str) {
  return String(str || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

function fmtSize(kb) {
  if (kb >= 1024) return (kb / 1024).toFixed(2) + " MB";
  return kb.toFixed(1) + " KB";
}

async function loadStorage() {
  const res = await fetch("/api/admin/storage");
  const data = await res.json();

  $("stat-total-mb").textContent = data.total_size_mb.toFixed(2) + " MB";
  $("stat-total-kb").textContent = data.total_size_kb.toFixed(1) + " KB total";
  $("stat-file-count").textContent = data.file_count;
  const avg = data.file_count > 0 ? (data.total_size_kb / data.file_count).toFixed(1) : "0";
  $("stat-avg-kb").textContent = avg + " KB";

  const tbody = $("storage-tbody");
  if (!data.files.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-dim)">No proof screenshots stored yet.</td></tr>`;
    return;
  }

  tbody.innerHTML = data.files.map(f => `
    <tr data-entry-id="${f.entry_id}">
      <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(f.title)}">${escHtml(f.title)}</td>
      <td style="font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono',monospace">${escHtml(f.filename)}</td>
      <td style="white-space:nowrap;font-size:12px">${fmtSize(f.size_kb)}</td>
      <td>
        <img src="/api/cpes/${f.entry_id}/proof?t=${Date.now()}"
          class="proof-thumb"
          onclick="window.open('/api/cpes/${f.entry_id}/proof','_blank')"
          title="Click to view full size"
          alt="proof">
      </td>
      <td>
        <button class="btn-danger btn-sm" onclick="deleteProof('${f.entry_id}', this)">Delete</button>
      </td>
    </tr>
  `).join("");
}

async function deleteProof(entryId, btn) {
  if (!confirm("Delete this proof screenshot? This cannot be undone.")) return;
  btn.disabled = true;
  try {
    const res = await fetch(`/api/cpes/${entryId}/proof`, { method: "DELETE" });
    if (res.ok) {
      showToast("Screenshot deleted");
      await loadStorage();
    } else {
      showToast("Delete failed", "error");
      btn.disabled = false;
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
    btn.disabled = false;
  }
}

async function backfillPresenters() {
  const btn = document.getElementById("btn-backfill");
  btn.disabled = true;
  btn.textContent = "Fixing…";
  try {
    const res = await fetch("/api/admin/backfill-presenters", { method: "POST" });
    const data = await res.json();
    showToast(`Updated ${data.updated} of ${data.checked} entries`);
  } catch (e) {
    showToast("Failed: " + e.message, "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "Fix Presenter Names";
  }
}

async function backfillTitles() {
  const btn = document.getElementById("btn-backfill-titles");
  btn.disabled = true;
  btn.textContent = "Fixing…";
  try {
    const res = await fetch("/api/admin/backfill-titles", { method: "POST" });
    const data = await res.json();
    showToast(`Updated ${data.updated} of ${data.checked} entries`);
  } catch (e) {
    showToast("Failed: " + e.message, "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "Fix Titles";
  }
}

async function backfillSubtitles() {
  const btn = document.getElementById("btn-backfill-subtitles");
  btn.disabled = true;
  btn.textContent = "Fixing…";
  try {
    const res = await fetch("/api/admin/backfill-subtitles", { method: "POST" });
    const data = await res.json();
    showToast(`Updated ${data.updated} of ${data.checked} entries`);
  } catch (e) {
    showToast("Failed: " + e.message, "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "Fix Subtitles";
  }
}

loadStorage();
</script>
</body>
</html>
