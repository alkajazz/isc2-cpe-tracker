<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cybersecurity CPE Tracker — Config</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    /* FOUC prevention — apply saved mode before CSS paints */
    (function(){
      var m = localStorage.getItem("cpe_mode") || "dark";
      if (m === "light") document.documentElement.dataset.mode = "light";
    })();
  </script>
</head>
<body>

<header>
  <div class="header-brand">
    <svg class="header-seal" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M16 2 L28 6.5 L28 17.5 Q28 26 16 30 Q4 26 4 17.5 L4 6.5 Z"
        stroke-width="1.2" style="fill:var(--accent-dim);stroke:var(--accent)"/>
      <path d="M16 5.5 L25 9 L25 17.5 Q25 24 16 27 Q7 24 7 17.5 L7 9 Z"
        fill="none" stroke-width="0.6" style="stroke:var(--accent-line)"/>
      <text x="16" y="18.5" text-anchor="middle"
        font-family="DM Sans, system-ui, sans-serif" font-size="7" font-weight="700" letter-spacing="0.1em"
        style="fill:var(--accent-bright)">CPE</text>
    </svg>
    <div class="header-title">
      <h1>Cybersecurity CPE Tracker</h1>
      <span class="header-subtitle">Continuing Professional Education</span>
    </div>
  </div>
  <nav class="header-nav">
    <a href="/" class="header-nav-link">Dashboard</a>
    <a href="/config.html" class="header-nav-link active">Config</a>
    <a href="/admin.html" class="header-nav-link">Admin</a>
    <a href="/storage.html" class="header-nav-link">Storage</a>
    <div class="header-vsep"></div>
    <button id="btn-mode-toggle" class="btn-secondary btn-sm" onclick="toggleMode()">Light</button>
  </nav>
  <div class="header-actions">
    <div class="theme-palette" aria-label="Accent colour">
      <button class="theme-swatch" data-theme="amber" style="background:#e8950f" title="Amber"></button>
      <button class="theme-swatch" data-theme="red"    style="background:#e04444" title="Red"></button>
      <button class="theme-swatch" data-theme="green"  style="background:#27ae63" title="Green"></button>
      <button class="theme-swatch" data-theme="blue"   style="background:#2389d4" title="Blue"></button>
      <button class="theme-swatch" data-theme="purple" style="background:#8b52e0" title="Purple"></button>
      <button class="theme-swatch" data-theme="cyan"   style="background:#12b0b0" title="Cyan"></button>
    </div>
  </div>
</header>

<main>

  <!-- Certification Mode -->
  <section class="config-section">
    <div class="config-section-label">Certification Mode</div>
    <div class="card" style="padding:20px">

      <div class="form-field" style="margin-bottom:16px">
        <label>Active CPE Modes</label>
        <div class="domain-check-grid" id="vendor-checkboxes"></div>
        <div class="form-hint">Select all certifications you hold. CPE hour inputs on the dashboard will use the merged rules across all selected modes.</div>
      </div>

      <table class="vendor-rules-table">
        <thead>
          <tr>
            <th>Vendor</th>
            <th>Credit Label</th>
            <th>Step</th>
            <th>Max</th>
            <th>Accepts</th>
            <th>Calculation Rule</th>
            <th>Proof</th>
          </tr>
        </thead>
        <tbody id="vendor-rules-tbody"></tbody>
      </table>

      <div id="vendor-notice" class="vendor-notice" style="display:none">
        <strong>Webinar-only vendors selected</strong><br>
        ISACA and CompTIA only award credits for <strong>webinar</strong> submissions —
        podcast and article entries will not count toward these certifications.<br><br>
        <strong>CompTIA requires</strong> proof of registration or proof of completion for all webinar submissions.<br>
        <strong>ISACA recommends</strong> keeping proof of completion (screenshot or attendance certificate).<br><br>
        Log webinars manually: <strong>Dashboard → Add Entry → Type: Webinar</strong>.
      </div>

    </div>
  </section>

  <!-- RSS Feeds management -->
  <section class="config-section">
  <div class="config-section-label">RSS Feeds</div>
  <div class="card" style="margin-bottom:0;padding:20px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h2 style="margin:0;font-size:15px;font-weight:600;letter-spacing:0.04em;color:var(--accent-bright)">RSS Feeds</h2>
    </div>

    <table id="feeds-table" style="width:100%;border-collapse:collapse;margin-bottom:16px">
      <thead>
        <tr>
          <th style="text-align:left;padding:6px 10px;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);border-bottom:1px solid var(--border)">Feed Name</th>
          <th style="text-align:left;padding:6px 10px;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);border-bottom:1px solid var(--border)">URL</th>
          <th style="text-align:center;padding:6px 10px;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);border-bottom:1px solid var(--border)">Days</th>
          <th style="text-align:center;padding:6px 10px;font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-muted);border-bottom:1px solid var(--border)">Status</th>
          <th style="padding:6px 10px;border-bottom:1px solid var(--border)"></th>
        </tr>
      </thead>
      <tbody id="feeds-tbody">
        <tr><td colspan="5" style="text-align:center;padding:24px;color:var(--text-dim)">Loading…</td></tr>
      </tbody>
    </table>

    <div class="feed-add-row">
      <input id="feed-url-input" type="url" placeholder="https://example.com/feed.xml"
        style="flex:1;min-width:240px;padding:6px 10px;background:var(--bg-input,var(--bg-card));border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px;font-family:inherit"
        onkeydown="if(event.key==='Enter')addFeed()">
      <input id="feed-name-input" type="text" placeholder="Feed name (optional — auto-detected)"
        style="flex:1;min-width:180px;padding:6px 10px;background:var(--bg-input,var(--bg-card));border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:13px;font-family:inherit"
        onkeydown="if(event.key==='Enter')addFeed()">
      <button class="btn-secondary btn-sm" onclick="addFeed()" id="btn-add-feed">+ Add Feed</button>
    </div>
  </div>
  </section>

</main>

<div id="toast"></div>

<script>
// ---------------------------------------------------------------------------
// Theme — must match THEMES object in app.js exactly
// ---------------------------------------------------------------------------
const THEMES = {
  amber:  { accent: "#c97d10", bright: "#e8950f", dim10: "rgba(201,125,16,0.10)", dim13: "rgba(201,125,16,0.13)", dim06: "rgba(201,125,16,0.06)", line: "rgba(201,125,16,0.30)" },
  red:    { accent: "#b83232", bright: "#e04444", dim10: "rgba(184,50,50,0.10)",   dim13: "rgba(184,50,50,0.13)",   dim06: "rgba(184,50,50,0.06)",   line: "rgba(184,50,50,0.30)"   },
  green:  { accent: "#1e8a4c", bright: "#27ae63", dim10: "rgba(30,138,76,0.10)",   dim13: "rgba(30,138,76,0.13)",   dim06: "rgba(30,138,76,0.06)",   line: "rgba(30,138,76,0.30)"   },
  blue:   { accent: "#1a6fab", bright: "#2389d4", dim10: "rgba(26,111,171,0.10)",  dim13: "rgba(26,111,171,0.13)",  dim06: "rgba(26,111,171,0.06)",  line: "rgba(26,111,171,0.30)"  },
  purple: { accent: "#6e3abf", bright: "#8b52e0", dim10: "rgba(110,58,191,0.10)",  dim13: "rgba(110,58,191,0.13)",  dim06: "rgba(110,58,191,0.06)",  line: "rgba(110,58,191,0.30)"  },
  cyan:   { accent: "#0d8a8a", bright: "#12b0b0", dim10: "rgba(13,138,138,0.10)",  dim13: "rgba(13,138,138,0.13)",  dim06: "rgba(13,138,138,0.06)",  line: "rgba(13,138,138,0.30)"  },
};

function applyTheme(name) {
  const t = THEMES[name] || THEMES.amber;
  const r = document.documentElement.style;
  r.setProperty("--accent",            t.accent);
  r.setProperty("--accent-bright",     t.bright);
  r.setProperty("--accent-dim",        t.dim10);
  r.setProperty("--warning-dim",       t.dim13);
  r.setProperty("--accent-dim-subtle", t.dim06);
  r.setProperty("--accent-line",       t.line);
  localStorage.setItem("cpe_theme", name);
  document.querySelectorAll(".theme-swatch").forEach(sw => {
    sw.classList.toggle("active", sw.dataset.theme === name);
  });
}

function toggleMode() {
  const next = document.documentElement.dataset.mode === "light" ? "dark" : "light";
  applyMode(next);
}

function applyMode(mode) {
  if (mode === "light") document.documentElement.dataset.mode = "light";
  else                  delete document.documentElement.dataset.mode;
  localStorage.setItem("cpe_mode", mode);
  const btn = document.getElementById("btn-mode-toggle");
  if (btn) btn.textContent = mode === "light" ? "Dark" : "Light";
}

// Apply saved theme and mode immediately (before paint)
applyTheme(localStorage.getItem("cpe_theme") || "amber");
applyMode(localStorage.getItem("cpe_mode") || "dark");

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".theme-swatch").forEach(sw => {
    sw.addEventListener("click", () => applyTheme(sw.dataset.theme));
  });
});

// ---------------------------------------------------------------------------

function $(id) { return document.getElementById(id); }

function showToast(msg, type = "success") {
  const t = $("toast");
  t.textContent = msg;
  t.className = `show ${type}`;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.className = ""; }, 3000);
}

function escHtml(str) {
  return String(str || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

// ---------------------------------------------------------------------------
// Vendor / Certification Mode
// ---------------------------------------------------------------------------

const VENDORS = {
  isc2:    { id: "isc2",    name: "ISC²",    step: 0.25, min: 0.25, max: 40,  label: "CPE Credits" },
  isaca:   { id: "isaca",   name: "ISACA",   step: 0.5,  min: 0.5,  max: 120, label: "CPE Credits" },
  comptia: { id: "comptia", name: "CompTIA", step: 0.5,  min: 0.5,  max: 40,  label: "CEUs" },
};
const VENDOR_IDS = ["isc2", "isaca", "comptia"];

function loadActiveVendors() {
  try {
    const saved = JSON.parse(localStorage.getItem("cpe_vendors"));
    if (Array.isArray(saved) && saved.length) return new Set(saved);
  } catch {}
  const legacy = localStorage.getItem("cpe_vendor");
  return new Set(legacy ? [legacy] : ["isc2"]);
}

function saveActiveVendors(activeSet) {
  localStorage.setItem("cpe_vendors", JSON.stringify([...activeSet]));
}

function toggleVendorMode(id, checked) {
  const active = loadActiveVendors();
  if (!checked && active.size === 1) {
    // Prevent deselecting the last mode — restore the checkbox
    const cb = document.querySelector(`#vendor-checkboxes input[value="${id}"]`);
    if (cb) cb.checked = true;
    showToast("At least one CPE mode must remain selected", "error");
    return;
  }
  if (checked) active.add(id);
  else active.delete(id);
  saveActiveVendors(active);
  renderVendorTable();
  showToast("CPE modes updated");
}

const VENDOR_CALC = {
  isc2:    "1 CPE per hour (round to ÷0.25)",
  isaca:   "1 CPE per 50 min active (floor to ÷0.25)",
  comptia: "1 CEU per hour of live attendance",
};

function renderVendorTable() {
  const active = loadActiveVendors();
  const hasRestricted = active.has("isaca") || active.has("comptia");

  // Render checkboxes
  $("vendor-checkboxes").innerHTML = VENDOR_IDS.map(id => {
    const v = VENDORS[id];
    return `<label class="domain-check">
      <input type="checkbox" value="${id}" ${active.has(id) ? "checked" : ""}
        onchange="toggleVendorMode('${id}', this.checked)">
      <span class="cert-badge cert-${id}">${v.name}</span> ${v.label}
    </label>`;
  }).join("");

  // Show/hide webinar restriction notice
  const notice = $("vendor-notice");
  if (notice) notice.style.display = hasRestricted ? "" : "none";

  // Render rules table — highlight active rows, add calc rule + acceptance columns
  $("vendor-rules-tbody").innerHTML = VENDOR_IDS.map(id => {
    const v = VENDORS[id];
    const accepts  = id === "isc2" ? "All types" : "<span class='type-badge type-webinar' style='font-size:9px'>Webinar only</span>";
    const proof    = id === "comptia" ? "<strong style='color:var(--danger-text)'>Required</strong>"
                   : id === "isaca"   ? "<span style='color:#4a9eff'>Recommended</span>"
                   : "—";
    return `<tr data-vendor="${id}" class="${active.has(id) ? "vendor-row-active" : ""}">
      <td><span class="cert-badge cert-${id}">${v.name}</span></td>
      <td>${v.label}</td>
      <td>${v.step} hr</td>
      <td>${v.max === 120 ? "no max" : v.max + " hr"}</td>
      <td>${accepts}</td>
      <td style="font-size:11px;color:var(--text-muted)">${VENDOR_CALC[id]}</td>
      <td>${proof}</td>
    </tr>`;
  }).join("");
}

// ---------------------------------------------------------------------------
// RSS Feed management
// ---------------------------------------------------------------------------

async function loadFeeds() {
  const tbody = $("feeds-tbody");
  try {
    const [feedsRes, cpesRes] = await Promise.all([
      fetch("/api/feeds"),
      fetch("/api/cpes"),
    ]);
    const feeds = await feedsRes.json();
    const cpes  = await cpesRes.json();

    // Build source → count map from live CPE entries
    const sourceCounts = {};
    for (const c of cpes) {
      const s = c.source || "";
      sourceCounts[s] = (sourceCounts[s] || 0) + 1;
    }

    if (!feeds.length) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--text-dim)">No feeds configured.</td></tr>`;
      return;
    }
    tbody.innerHTML = feeds.map(f => {
      const count = sourceCounts[f.name] || 0;
      const countBadge = count > 0
        ? `<span style="font-size:10px;color:var(--text-muted);margin-left:5px">${count} entries</span>`
        : "";
      const cutoffDays = f.cutoff_days ?? 60;
      return `
      <tr data-feed-id="${escHtml(f.id)}">
        <td style="padding:7px 10px;font-size:13px">${escHtml(f.name)}${countBadge}</td>
        <td style="padding:7px 10px;font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(f.url)}">${escHtml(f.url)}</td>
        <td style="padding:7px 10px;text-align:center;white-space:nowrap">
          <input type="number" class="days-input" min="1" max="365"
            value="${cutoffDays}"
            onchange="updateFeedDays('${escHtml(f.id)}', this.value)"
            title="Only fetch episodes published within this many days">
          <span class="days-label">days</span>
        </td>
        <td style="padding:7px 10px;text-align:center">
          <button class="btn-sm ${f.enabled ? 'btn-secondary' : 'btn-danger'}"
            onclick="toggleFeed('${escHtml(f.id)}', ${!f.enabled})"
            title="${f.enabled ? 'Click to disable' : 'Click to enable'}"
            style="min-width:60px">
            ${f.enabled ? '● On' : '○ Off'}
          </button>
        </td>
        <td style="padding:7px 10px;white-space:nowrap;text-align:right">
          <button class="btn-secondary btn-sm" onclick="fetchFeed('${escHtml(f.id)}')" style="margin-right:4px">Fetch</button>
          <button class="btn-danger btn-sm" onclick="deleteFeed('${escHtml(f.id)}', '${escHtml(f.name)}', ${count})">✕</button>
        </td>
      </tr>`;
    }).join("");
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--text-dim)">Failed to load feeds.</td></tr>`;
  }
}

async function addFeed() {
  const urlInput = $("feed-url-input");
  const nameInput = $("feed-name-input");
  const btn = $("btn-add-feed");
  const url = urlInput.value.trim();
  if (!url) { showToast("Enter a feed URL", "error"); return; }
  btn.disabled = true;
  btn.textContent = "Adding…";
  try {
    const body = { url };
    if (nameInput.value.trim()) body.name = nameInput.value.trim();
    const res = await fetch("/api/feeds", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    if (res.ok) {
      const feed = await res.json();
      showToast(`Feed "${feed.name}" added`);
      urlInput.value = "";
      nameInput.value = "";
      await loadFeeds();
    } else {
      const err = await res.json().catch(() => ({ detail: res.statusText }));
      showToast(err.detail || "Failed to add feed", "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  } finally {
    btn.disabled = false;
    btn.textContent = "+ Add Feed";
  }
}

async function toggleFeed(id, enabled) {
  try {
    const res = await fetch(`/api/feeds/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ enabled }),
    });
    if (res.ok) {
      await loadFeeds();
    } else {
      showToast("Failed to update feed", "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}

async function updateFeedDays(id, val) {
  const days = Math.max(1, Math.min(365, parseInt(val, 10) || 60));
  try {
    const res = await fetch(`/api/feeds/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ cutoff_days: days }),
    });
    if (res.ok) {
      showToast(`Sync window updated to ${days} days`);
    } else {
      showToast("Failed to update sync window", "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}

async function fetchFeed(id) {
  showToast("Fetching all feeds…");
  try {
    const res = await fetch("/api/fetch", { method: "POST" });
    const data = await res.json();
    showToast(`Fetched ${data.fetched} items, added ${data.added}`);
  } catch (e) {
    showToast("Fetch failed: " + e.message, "error");
  }
}

async function deleteFeed(id, name, entryCount) {
  const countLabel = entryCount > 0 ? ` (${entryCount} entries)` : "";
  const choice = await showDeleteDialog(name, countLabel);
  if (!choice) return;

  const purge = choice === "purge";
  const url = `/api/feeds/${id}${purge ? "?purge_data=true" : ""}`;
  try {
    const res = await fetch(url, { method: "DELETE" });
    if (res.ok || res.status === 204) {
      if (purge) {
        const data = await res.json().catch(() => ({}));
        showToast(`Feed removed — ${data.purged ?? 0} entries purged`);
      } else {
        showToast(`Feed "${name}" removed`);
      }
      await loadFeeds();
    } else {
      showToast("Delete failed", "error");
    }
  } catch (e) {
    showToast("Error: " + e.message, "error");
  }
}

function showDeleteDialog(name, countLabel) {
  return new Promise(resolve => {
    const old = document.getElementById("feed-delete-dialog");
    if (old) old.remove();

    const overlay = document.createElement("div");
    overlay.id = "feed-delete-dialog";
    overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:9999";

    overlay.innerHTML = `
      <div style="background:var(--surface2);border:1px solid var(--border-mid);border-radius:4px;padding:24px 28px;max-width:380px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.5)">
        <div style="font-size:14px;font-weight:600;margin-bottom:6px;color:var(--text)">Remove feed</div>
        <div style="font-size:13px;color:var(--text-muted);margin-bottom:20px">
          <span style="color:var(--accent-bright)">${escHtml(name)}</span><br>
          What should happen to the CPE entries imported from this feed?${countLabel ? `<span style="color:var(--text-dim)"> ${escHtml(countLabel)}</span>` : ""}
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="fdd-keep" class="btn-secondary" style="text-align:left;padding:8px 12px">
            <div style="font-weight:600;font-size:13px">Keep entries</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Remove feed config only — existing CPE entries are untouched</div>
          </button>
          <button id="fdd-purge" class="btn-danger" style="text-align:left;padding:8px 12px;border:1px solid var(--border-mid)">
            <div style="font-weight:600;font-size:13px">Remove feed + purge all entries</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px">Permanently deletes all imported CPE entries and proof images</div>
          </button>
          <button id="fdd-cancel" class="btn-secondary" style="margin-top:4px">Cancel</button>
        </div>
      </div>`;

    document.body.appendChild(overlay);
    document.getElementById("fdd-keep").onclick   = () => { overlay.remove(); resolve("keep"); };
    document.getElementById("fdd-purge").onclick  = () => { overlay.remove(); resolve("purge"); };
    document.getElementById("fdd-cancel").onclick = () => { overlay.remove(); resolve(null); };
    overlay.addEventListener("click", e => { if (e.target === overlay) { overlay.remove(); resolve(null); } });
  });
}

document.addEventListener("DOMContentLoaded", () => {
  renderVendorTable();
  loadFeeds();
});
</script>
</body>
</html>
